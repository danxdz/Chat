<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí Working Test</title>
    <script src="/sodium.js"></script>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .test {
            background: #2d2d2d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #0066cc;
        }
        .success { border-color: #28a745; }
        .error { border-color: #dc3545; }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .magic-link {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            word-break: break-all;
            margin: 10px 0;
            border: 1px solid #555;
        }
    </style>
</head>
<body>
    <h1>üîí Working System Test</h1>
    <p>Let's test everything step by step:</p>
    
    <div class="test" id="test1">
        <h3>1. Sodium Loading Test</h3>
        <button onclick="testSodium()">Test Sodium</button>
        <div id="sodium-result"></div>
    </div>
    
    <div class="test" id="test2">
        <h3>2. Magic Link Generation</h3>
        <button onclick="testMagicLink()">Generate Magic Link</button>
        <div id="magic-result"></div>
    </div>
    
    <div class="test" id="test3">
        <h3>3. Account Creation Test</h3>
        <button onclick="testAccount()">Create Test Account</button>
        <div id="account-result"></div>
    </div>
    
    <div class="test" id="test4">
        <h3>4. Login Test</h3>
        <button onclick="testLogin()">Test Login</button>
        <div id="login-result"></div>
    </div>

    <script>
        let sodium = null;
        let magicLink = null;

        async function testSodium() {
            const result = document.getElementById('sodium-result');
            result.innerHTML = 'Testing...';
            
            try {
                // Wait for sodium to be ready
                if (!window.sodium) {
                    throw new Error('window.sodium not available');
                }
                
                if (window.sodium.ready) {
                    await window.sodium.ready;
                } else {
                    throw new Error('sodium.ready not available');
                }
                
                sodium = window.sodium;
                
                // Test basic function
                const testData = 'hello world';
                const hash = sodium.crypto_hash(new TextEncoder().encode(testData));
                
                result.innerHTML = `
                    <div style="color: #28a745">‚úÖ Sodium working!</div>
                    <div>Hash test: ${sodium.to_hex(hash).substring(0, 16)}...</div>
                `;
                document.getElementById('test1').classList.add('success');
                
            } catch (error) {
                result.innerHTML = `<div style="color: #dc3545">‚ùå ${error.message}</div>`;
                document.getElementById('test1').classList.add('error');
            }
        }

        function testMagicLink() {
            const result = document.getElementById('magic-result');
            
            if (!sodium) {
                result.innerHTML = '<div style="color: #dc3545">‚ùå Run sodium test first</div>';
                return;
            }
            
            try {
                // Generate simple magic link
                const linkId = Math.random().toString(36).substring(2, 15);
                const timestamp = Date.now();
                const expiresAt = timestamp + (24 * 60 * 60 * 1000); // 24 hours
                
                const inviteData = {
                    id: linkId,
                    createdBy: 'System',
                    createdAt: timestamp,
                    expiresAt: expiresAt,
                    used: false
                };
                
                // Store in localStorage
                localStorage.setItem(`invite_${linkId}`, JSON.stringify(inviteData));
                
                // Create URL
                const linkToken = btoa(JSON.stringify({
                    id: linkId,
                    timestamp: timestamp,
                    signature: btoa(`${linkId}:${timestamp}`).substring(0, 16)
                }));
                
                magicLink = `${window.location.origin}?invite=${linkToken}`;
                localStorage.setItem('startupMagicLink', magicLink);
                
                result.innerHTML = `
                    <div style="color: #28a745">‚úÖ Magic link created!</div>
                    <div class="magic-link">${magicLink}</div>
                    <button onclick="navigator.clipboard.writeText('${magicLink}')">üìã Copy</button>
                `;
                document.getElementById('test2').classList.add('success');
                
            } catch (error) {
                result.innerHTML = `<div style="color: #dc3545">‚ùå ${error.message}</div>`;
                document.getElementById('test2').classList.add('error');
            }
        }

        function testAccount() {
            const result = document.getElementById('account-result');
            
            if (!sodium || !magicLink) {
                result.innerHTML = '<div style="color: #dc3545">‚ùå Run previous tests first</div>';
                return;
            }
            
            try {
                // Simulate account creation
                const testPIN = '1234';
                const testNickname = 'TestUser';
                
                // Hash PIN with sodium
                const salt = new Uint8Array([
                    0x73, 0x65, 0x63, 0x75, 0x72, 0x65, 0x63, 0x68,
                    0x61, 0x74, 0x73, 0x61, 0x6c, 0x74, 0x76, 0x31
                ]);
                
                const hashedPIN = sodium.crypto_pwhash(
                    32,
                    testPIN,
                    salt,
                    sodium.crypto_pwhash_OPSLIMIT_INTERACTIVE,
                    sodium.crypto_pwhash_MEMLIMIT_INTERACTIVE,
                    sodium.crypto_pwhash_ALG_ARGON2ID
                );
                
                const hashedPINHex = sodium.to_hex(hashedPIN);
                
                // Store account data
                localStorage.setItem('testAccount', JSON.stringify({
                    nickname: testNickname,
                    hashedPIN: hashedPINHex,
                    created: new Date().toISOString()
                }));
                
                result.innerHTML = `
                    <div style="color: #28a745">‚úÖ Test account created!</div>
                    <div>Nickname: ${testNickname}</div>
                    <div>PIN Hash: ${hashedPINHex.substring(0, 16)}...</div>
                `;
                document.getElementById('test3').classList.add('success');
                
            } catch (error) {
                result.innerHTML = `<div style="color: #dc3545">‚ùå ${error.message}</div>`;
                document.getElementById('test3').classList.add('error');
            }
        }

        function testLogin() {
            const result = document.getElementById('login-result');
            
            if (!sodium) {
                result.innerHTML = '<div style="color: #dc3545">‚ùå Run previous tests first</div>';
                return;
            }
            
            try {
                const accountData = localStorage.getItem('testAccount');
                if (!accountData) {
                    throw new Error('No test account found');
                }
                
                const account = JSON.parse(accountData);
                const testPIN = '1234';
                
                // Re-hash PIN
                const salt = new Uint8Array([
                    0x73, 0x65, 0x63, 0x75, 0x72, 0x65, 0x63, 0x68,
                    0x61, 0x74, 0x73, 0x61, 0x6c, 0x74, 0x76, 0x31
                ]);
                
                const hashedPIN = sodium.crypto_pwhash(
                    32,
                    testPIN,
                    salt,
                    sodium.crypto_pwhash_OPSLIMIT_INTERACTIVE,
                    sodium.crypto_pwhash_MEMLIMIT_INTERACTIVE,
                    sodium.crypto_pwhash_ALG_ARGON2ID
                );
                
                const hashedPINHex = sodium.to_hex(hashedPIN);
                
                if (hashedPINHex === account.hashedPIN) {
                    result.innerHTML = `
                        <div style="color: #28a745">‚úÖ Login successful!</div>
                        <div>Logged in as: ${account.nickname}</div>
                        <div>PIN verification: PASSED</div>
                    `;
                    document.getElementById('test4').classList.add('success');
                } else {
                    throw new Error('PIN verification failed');
                }
                
            } catch (error) {
                result.innerHTML = `<div style="color: #dc3545">‚ùå ${error.message}</div>`;
                document.getElementById('test4').classList.add('error');
            }
        }

        // Auto-start first test
        window.addEventListener('load', () => {
            setTimeout(testSodium, 1000);
        });
    </script>
</body>
</html>