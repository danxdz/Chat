<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí Final System Test</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            line-height: 1.6;
        }
        .test-result {
            background: #2d2d2d;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }
        .success { border-color: #28a745; }
        .error { border-color: #dc3545; }
        .summary {
            background: #0066cc;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üîí Final System Verification</h1>
    <p>Testing all components end-to-end...</p>
    
    <div id="results"></div>
    <div id="summary" class="summary" style="display: none;"></div>

    <script>
        const results = document.getElementById('results');
        const summary = document.getElementById('summary');
        let tests = [];

        async function runAllTests() {
            // Test 1: React App Structure
            await testReactApp();
            
            // Test 2: Magic Links
            await testMagicLinks();
            
            // Test 3: Crypto Functions
            await testCrypto();
            
            // Test 4: Storage System
            await testStorage();
            
            // Test 5: Component Integration
            await testComponents();
            
            // Show final summary
            showSummary();
        }

        function logTest(name, success, message) {
            const test = { name, success, message };
            tests.push(test);
            
            const div = document.createElement('div');
            div.className = `test-result ${success ? 'success' : 'error'}`;
            div.innerHTML = `
                <h3>${success ? '‚úÖ' : '‚ùå'} ${name}</h3>
                <p>${message}</p>
            `;
            results.appendChild(div);
        }

        async function testReactApp() {
            try {
                // Check if React root exists
                const root = document.getElementById('root');
                const hasRoot = !!root;
                
                // Check if main.jsx script exists
                const scripts = Array.from(document.scripts);
                const hasMainScript = scripts.some(script => script.src.includes('main.jsx'));
                
                if (hasRoot && hasMainScript) {
                    logTest('React App Structure', true, 'React root element and main.jsx script found');
                } else {
                    logTest('React App Structure', false, `Missing: ${!hasRoot ? 'root element' : ''} ${!hasMainScript ? 'main.jsx script' : ''}`);
                }
            } catch (error) {
                logTest('React App Structure', false, error.message);
            }
        }

        async function testMagicLinks() {
            try {
                // Test magic link generation (like the startup module does)
                const linkId = Math.random().toString(36).substring(2, 15);
                const timestamp = Date.now();
                
                const inviteData = {
                    id: linkId,
                    createdBy: 'System',
                    createdAt: timestamp,
                    expiresAt: timestamp + (24 * 60 * 60 * 1000),
                    used: false
                };
                
                // Store in localStorage
                localStorage.setItem(`test_invite_${linkId}`, JSON.stringify(inviteData));
                
                // Create URL
                const linkToken = btoa(JSON.stringify({
                    id: linkId,
                    timestamp: timestamp,
                    signature: btoa(`${linkId}:${timestamp}`).substring(0, 16)
                }));
                
                const magicUrl = `${window.location.origin}?invite=${linkToken}`;
                
                // Validate the generated link
                if (magicUrl && magicUrl.includes('?invite=') && linkToken) {
                    logTest('Magic Link Generation', true, `Magic link created: ${linkId}`);
                } else {
                    logTest('Magic Link Generation', false, 'Failed to create valid magic link');
                }
                
                // Cleanup
                localStorage.removeItem(`test_invite_${linkId}`);
                
            } catch (error) {
                logTest('Magic Link Generation', false, error.message);
            }
        }

        async function testCrypto() {
            try {
                // Test if sodium is available
                if (!window.sodium) {
                    throw new Error('window.sodium not available');
                }
                
                // Wait for sodium to be ready
                if (window.sodium.ready) {
                    await window.sodium.ready;
                }
                
                // Test basic crypto functions
                const testData = 'test data for crypto';
                const hash = window.sodium.crypto_hash(new TextEncoder().encode(testData));
                const hashHex = window.sodium.to_hex(hash);
                
                // Test PIN hashing
                const testPIN = '1234';
                const salt = new Uint8Array(16);
                salt.fill(0x42); // Simple test salt
                
                const hashedPIN = window.sodium.crypto_pwhash(
                    32,
                    testPIN,
                    salt,
                    window.sodium.crypto_pwhash_OPSLIMIT_INTERACTIVE,
                    window.sodium.crypto_pwhash_MEMLIMIT_INTERACTIVE,
                    window.sodium.crypto_pwhash_ALG_ARGON2ID
                );
                
                const hashedPINHex = window.sodium.to_hex(hashedPIN);
                
                if (hashHex && hashedPINHex) {
                    logTest('Crypto Functions', true, `Hash and PIN hashing working. PIN hash: ${hashedPINHex.substring(0, 16)}...`);
                } else {
                    logTest('Crypto Functions', false, 'Crypto functions returned empty results');
                }
                
            } catch (error) {
                logTest('Crypto Functions', false, error.message);
            }
        }

        async function testStorage() {
            try {
                // Test localStorage operations
                const testKey = 'test_storage_key';
                const testData = { test: 'data', timestamp: Date.now() };
                
                // Store data
                localStorage.setItem(testKey, JSON.stringify(testData));
                
                // Retrieve data
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                
                // Verify data
                if (retrieved && retrieved.test === 'data' && retrieved.timestamp === testData.timestamp) {
                    logTest('Storage System', true, 'localStorage read/write operations working');
                } else {
                    logTest('Storage System', false, 'localStorage data mismatch');
                }
                
                // Cleanup
                localStorage.removeItem(testKey);
                
            } catch (error) {
                logTest('Storage System', false, error.message);
            }
        }

        async function testComponents() {
            try {
                // Test if component files can be imported (basic check)
                const hasDevMenu = !!document.getElementById('dev-nav');
                const hasToggleButton = !!document.querySelector('.toggle-nav');
                const hasMagicLinkDisplay = !!document.getElementById('magic-link-display');
                
                if (hasDevMenu && hasToggleButton && hasMagicLinkDisplay) {
                    logTest('Component Integration', true, 'Dev menu and magic link components present');
                } else {
                    logTest('Component Integration', false, 'Missing UI components');
                }
                
            } catch (error) {
                logTest('Component Integration', false, error.message);
            }
        }

        function showSummary() {
            const passed = tests.filter(t => t.success).length;
            const total = tests.length;
            const success = passed === total;
            
            summary.innerHTML = `
                <h2>${success ? 'üéâ' : '‚ö†Ô∏è'} System ${success ? 'FULLY FUNCTIONAL' : 'NEEDS ATTENTION'}</h2>
                <p><strong>${passed}/${total} tests passed</strong></p>
                ${success ? 
                    '<p>‚úÖ ALL SYSTEMS WORKING - READY FOR PRODUCTION!</p>' :
                    '<p>‚ùå Some components need fixing before deployment</p>'
                }
                <div style="margin-top: 20px;">
                    <div>üîó <strong>Next Steps:</strong></div>
                    <div>${success ? 
                        '1. Test on Vercel deployment<br>2. Click üõ†Ô∏è DEV ‚Üí Copy magic link<br>3. Open magic link ‚Üí Create account<br>4. Test full user flow' :
                        '1. Fix failing tests<br>2. Re-run verification<br>3. Then test on Vercel'
                    }</div>
                </div>
            `;
            summary.style.display = 'block';
        }

        // Run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>